====================================================
Автоматизация поиска гербарных записей в базе данных
====================================================


.. contents:: :local:


--------
Введение
--------

.. |--| unicode:: U+2013   .. en dash



Параметры запросов
------------------

При формировании поисковых запросов к серверу допустимы только GET-запросы (протокол HTTP(S)).


Параметры ответа сервера
------------------------


Ответ сервера на поисковый запрос представляет собой JSON-текст, передаваемый по протоколу HTTP, и имеющий следующие поля:

- **errors** -- массив ошибок, возникших при обработке поискового запроса.
- **warnings** -- массив предупреждений, возникших при обработке поискового запроса. Предупреждениями являются различные поисковые ситуации: например, отсутствие данных, удовлетворяющих текущему поисковому запросу, игнорирование тех или иных поисковых параметров, при их противоречивости и т.п.
- **data** |--| массив структурированных данных гербарных записей, удовлетворяющих текущему поисковому запросу.


Структура массива данных
~~~~~~~~~~~~~~~~~~~~~~~~


Параметр `data` представляет собой массив данных, удовлетворяющих текущему поисковому зарпосу.

Он имеет следующую структуру, описывающее текущий гербарный сбор:

- `family` -- название семейства (заглавными буквами, на латыни); 
- `family_authorship` -- автор семейста; 
- `genus` -- название рода;
- `genus_authorship` -- автор рода;
- `species_epithet` -- видовой эпитет;
- `species_id` -- `ID` вида образца; не путать с `ID` текущей гербарной записи. `ID` текущей гербарной записи однозначно характеризует данную оцифрованную гербарную запись. `ID` вида образца, только вид. Гербарных записей, содержащих какой-либо вид может быть много.
- `species_authorship` -- автор вида;
- `species_status` -- текущий статус вида; определяет степень признанности данного вида, точнее триплета (род, видовой эпитет, авторство вида) в научном сообществе на настоящее время. Возможные значения данного параметра 1) "Recently added" -- вид недавно добавлен и, скорее, не проверялся специалистом; название вида с таким статусом может быть устаревшим, либо содержатьошибки; 2) "Approved" -- название вида подтверждено специалистом; 3) "Deleted" -- вид имеет ошибку в записи, или устарели и не используется; 4) "From plantlist" -- название импортировано из базы http://theplantlist.org.
- `species_fullname` -- полное название вида, т.е. Род + видовой эпитет + авторство.
- `id` -- уникальный идентификатор данной гербарной записи; всегда целое число;
- `gpsbased` -- получены ли данные о географической привязки места сбора образца с помощью GPS (значение `true`), либо другим способом (`false`); следует иметь ввиду, что у многих образцов, даже при `gpsbased` равном `false`, координаты, если таковые заданы, были получены при помощи GPS; это связано с тем, что не все отмечают соответствующее поле (`gpsbased`) при заполнении электронной формы образца.  
- `latitude` --  широта, градусы; георафическая координата места сбора в системе WGS-84;
- `longitude` -- долгота, градусы; географическая координата места сбора в системе WGS-84;
- `fieldid` -- полевой номер образца;
- `itemcode` -- инвентаризационный номер, используемый в гербарном хранилище;
- `acronym` -- гербарный акроним, которому принадлежит данная гербарная запись (для большинства записей поле имеет значение `VBGI`);
- `branch` -- подраздел гербария внутри акронима; иногда удобно иметь подразделы внутри общей гербарной базы: например, "гербарий грибов", "биоморфологический гербарий" и т.п.
- `collectors` -- текстовая строка: сборщики образца;
- `identifiers` -- текстовая страка: те, кто определил вид гербарного сбора;
- `devstage` -- стадия развития; определена для биоморфологического гербария; возможные значения: Development stage partly, Life form, или пустое поле;
- `updated` -- дата последнего изменения записи в базе данных;
- `created` -- дата создания записи (т.е. занесения её электронную базу данных);
- `identification_started` -- дата начала определения вида;
- `identification_finished` -- дата окончания определения вида; дата определения вида задана в виде интервала, поскольку не всегда может быть указана точная дата, а например,только месяц, или время проведения какой-либо экспедиции; 
- `country` --  название страны сбора образца;
- `country_id` -- числовой идентификатор страны сбора образца;
- `altitude` -- высота над уровнем моря места сбора образца; значение представляется собой строку, не всегда однозначно определяющую реальную высоту сбора. Возможны, например, варианты: 100-300 м, 120 м, 400, 300-400 и т.п. 
- `region` -- регион сбора;
- `district` -- район сбора;
- `details` -- экологические условия сбора, дополнительные уточнения не вошедшие в поля регион и район;
- `dethistory` -- представляет собой массив -- историю определений вида гербарного сбора;
- `additionals` -- некоторые гербарные сборы могут содержать более одного вида, данный массив описывает характеристики каждого из них;

Структура массивов `dethistory` и `additionals` приводится в следующем параграфе.

История определений и дополнительные сборы
``````````````````````````````````````````

**История определений**

Каждый элемент массива "История определения" (`dethistory`) представляет собой описание
попытки определения (переопределения) вида в текущем гербарном сборе и имеет
следующие поля:

- `valid_from` -- дата валидности определения;
- `valid_to`-- дата окончания валидности определения; поле может быть не задано, что означает, что предполагает, что определение актуально в настоящее время;
- `family` -- название семейства;
- `family_authorship` -- авторство семейства;
- `genus` -- название рода;
- `genus_authorship` -- автор рода;
- `species_epithet` -- видовой эпитет;
- `species_id` -- `ID` вида образца; 
- `species_authorship` -- автор вида;
- `species_status` -- текущий статус вида;
- `species_fullname` -- полное название вида, т.е. Род + видовой эпитет + авторство.








Ограничения
-----------

Поскольку поисковому запросу пользователя может удовлетворять большой объём данных,
формирование ответа сервера также может занять много времени. 

Для передачи данных
в этом случае используется keep-alive HTTP-соединение; количество одновременно возможных
таких соединений для сервиса автоматизированного опроса гербарной базы определяется текущим значением параметра JSON_API_SIMULTANEOUS_CONN_.

.. _JSON_API_SIMULTANEOUS_CONN:  https://github.com/VBGI/herbs/blob/master/herbs/conf.py

По превышении этого количества, сервер не обрабатывает поисковые запросы, а возвращает
сообщение об ошибке.


Примеры
-------





