=======================================================
Положения по работе с электронным гербарием БСИ ДВО РАН
=======================================================


.. contents:: :local:


--------
Введение
--------

В документе изложены основные принципы работы с формой администрирования, ее основные функции,
права пользователей; 


-----------------------------
Аутентификация и безопасность
-----------------------------

Аутентификация осуществляется по предоставленному имени пользователя и паролю.

Пароль рекомендуется сменить после первого успешного входа в зону администрирования. 
Это можно сделать, перейдя по ссылке в правом верхнем углу окна администрирования. 

Пароли не хранятся в открытом виде в системе, у администратора системы (или сотрудника с правами суперпользователя) не существует (кроме прямого подбора) способа, чтобы узнать пароль; однако, суперпользователь
может изменить пароль любого другого пользователя.

После ста неудачных попыток авторизации IP, с которого были сделаны попытки, блокируется на час.

Если пользователь в течение четырех часов работы в системе не производит никаких действий -- сохранений, переходов на другие страницы, то срок валидности его сессии истекает. 
По истечении срока сессии пользователю необходимо пройти аутентификацию заново (ввести имя пользователя и пароль), чтобы иметь возможность редактировать образцы. 


-------------------------------
Структура электронного гербария
-------------------------------

Электронный гербарий представляет собой многопользовательское web-приложение, которое позволяет
организовать хранение\\изменение\\добавление данных с учетом разграничения пользовательских прав, названий гербария и гербарных подгрупп.

Разграничение гербарных записей в общей таблице осуществляется по двум основным полям -- принадлежности определенному гербарию (гербарному акрониму) и группе сбора. Группа сбора представляет собой условное разграничение, используемое для удобства внутреннего управления гербарием. 

Например, может потребоваться необходимость внутри данного гербария (например, VBGI), выделить биоморфологический гербарий, или коллекции грибов и пр. Для этих целей могут использоваться гербарные группы. 
Существование гербарных групп никак не влияет на функции поиска записей и используется лишь для внутренних целей администрирования, в том числе, для разграничения прав.

Каждая гербарная запись, независимо от принадлежности гербарному акрониму или гербарной группе, получает при своем сохранении уникальный, привязанный только к этой записи, целочисленный номер ID. Он назначаетсясистемой автоматически. Даже при удалении образца, данный номер уже не будет занят.

Наряду с акронимом и\\или гербарной группой уникальный  ID  назначается при сохранении записи в базу, поэтому увидеть текущий,


Гербарные акронимы
------------------

Гербарные акронимы -- индентификаторы принадлежности тому или иному гербарию (например, гербарию БСИ ДВО РАН, или гербарию Амурского филиала БСИ ДВО РАН) хранятся в отдельной таблице акронимов, редактирование которой разрешено только суперпользователю (см. о правах суперпользователя в разделе `Группы пользователей и права`_).
Пользователи, авторизуемые в системе администрирования, привязаны к тому или иному акрониму. Когда они сохраняют заполненный гербарный образец, доступное только для чтения (изначально пустое) поле акронима, заполняется автоматически в соответствии с этой привязкой.

Каждая запись таблицы акронимов (в настоящий момент таблиц хранит только две записи -- VBGI, AmBGI)
хранит информацию о физическом размещении гербария (его адрес на англ. языке), привязку к пользователям, собственно сокращенное название (т.е. VBGI, AmBGI).

Акронимы используются для разграничения прав кураторов. Куратор гербария привязывается к тому или иному акрониму, но не имеет доступа к гербарным записям принадлежащим другому акрониму.

Информация, содержащаяся в таблице акронимов (адрес гербария, международное соращение гербария) используются при генерации этикетки.

Если требуется внести изменения в таблицу акронимов, например, исправить AmBGI на ABGI или что-то подобное, изменить адрес гербария, нужно обращаться к сотруднику с правами суперпользователя системы.

Гербарные группы
----------------

Гербарная группа -- необязательное автоматически назначаемое поле при добавлении гербарной записи.
Оно может быть пустым, либо заполняется при сохранении образца с учетом привязки конкретного пользователя
к гербарной группе. 

Если пользователь с правами куратора привязан к гербарной группе, то он является куратором только данной гербарной группы (см. также `Группы пользователей и права`_). 

Таблица гербарных групп с из наименованиями и привязкой к конкретным пользователям редактируется сотрудником с правами суперпользователя. 

Если текущий пользователь, редактирующий гербарий, не привязан ни к какой гербарной группе, при сохранении поле гербарная группа остается пустым.


Группы пользователей и права
----------------------------

Суперпользователь -- имеет права на все; за исключением удаления\\изменения опубликованных гербарных образцов. 

Куратор
~~~~~~~

Куратор гербария -- осуществляет мониторинг всех гербарных записей в рамках акронима, к которому он привязан.

Кроме того:

- куратор может быть привязан только к одному гербарному акрониму;
- куратор осуществляет публикацию (и\\или снятие с публикации) гербарных образцов;
- куратор может редактировать и просматривать любые гербарные образцы в рамках своего акронима;
- куратор не может удалять виды, рода или семейства, но может их добавлять; 
- куратор может исключить вид из результатов поиска во всплывающих подсказках, присвоив данному виду статус "Deleted";  
- куратор может добавлять\\изменять названия уже добавленных видов (при этом изменения скажутся сразу на всех образца, у которых указан данный вид: например, если вид *Betula mandshurica* в таблице видов переименовать на *Betula davurica*, то все образцы, где был указан до переименования вид *Betula mandsurica*, после переименования будут иметь вид *Betula davurica*);
- куратор может удалять любые образцы в рамках своего акронима

Куратор гербарной группы
~~~~~~~~~~~~~~~~~~~~~~~~

Если имя пользователя с правами куратора привязано к какой-либо гербарной группе, то все права куратора ограничиваются только данной гербарной группой. Он, соответственно, не может просматривать и редактировать образцы вне данной гербарной группы. Остальные права куратора гербарной группы идентечны правам куратора гербария. 

Регулярный пользователь (наборщик)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Осуществляет набор данных от своего имени. Регулярный пользователь может быть дополнительно привязан к гербарной группе. В этом случае, сохранение образца влечет автоматическое назначение этой гербарной группе данной гербарной записи. 

- регулярный пользователь может просматривать и редактировать\\удалять только собственно созданные записи;
- может создавать новые виды; 
- не может создавать рода и семейства;
- не может изменять статус видов;
- не может публиковать гербарные записи;
  

Существует еще отдельный набор прав -- "редактор криптогамного гербария", который подразумевает, что
форма редактирования образца дополняется еще дополнительными полями, отражающими дополнительные
виды присутствующие в данном сборе. Это функция "мультивидовых сборов" для одной записи; в обычном
гербарии сосудистых растений такая функция не нужна, поэтому она включается только при присвоении пользователю определенного набора прав.

--------------------------
Поля формы и их назначение
--------------------------

Любые поля формы, выделенные жирным шрифтом, обязательны для заполнения. 

В форме редактирования гербарных образцов такое поле одно -- это поле **Вид**.

Вид 
---

Заполнить поле вид можно только элементом из всплывающей подсказки. Подсказка формируется по уже добавленным видам в базу, а также более чем 500.000 (по состоянию на конец 2016 г) видам из базы данных theplantlist.org.

Поиск выполняется как только набрано 3 и более символов в поле **Вид**; при этом полагается, что первые символы -- должны состоять в названии рода, а последующие, если они идут через пробел -- видового эпитета.
Иными словами, если мы вводим в поисковое поле **Вид**: *Tra*, то в поиске появятся все виды с родами, начинающиеся на *Tra*, при этом количество видимых вариантов будет ограничено 50 вариантами; если в поисковом поле **Вид** будет, например, *Tra ps*, то найдутся все виды,  рода у которых начинаются  на *Tra*, и, кроме того, видовой эпитет содержит *ps*, т.е., например, *Trapa pseudoincisa* и т.п.

Если требуемый вид отсутствует, нужно нажать рядом кнопку в виде "зеленого плюса" и добавить недостающий вид. Если отсутствует необходимый род и\\или семейство, необходимо обратиться к сотруднику с правами куратора и\\или суперпользователя, чтобы добавить недостающие названия. 

Код образца 
-----------

Уникальный в рамках данного акронима числовой код, назначаемый куратором. Этот код опциональный и может не заполняться. Однако, в некоторых публикациях могут быть ссылки на гербарные образцы с указанием этого кода, поэтому он может быть важен.

Если существует, отражается на этикетке; если не задан -- вместо него используется символ "*".


Полевой код
-----------

Опциональный код. Его назначает сборщик гербария; его максимальная длина 20 символов, при этом допустимо
использовать любые символы в рамках кодировки utf-8 (т.е. там могут быть и японские иероглифы).

Также может быть важным для ссылкок. 

Если существует, то отражается на этикетке. 


Acronym 
-------

Автозаполняемое поле. Оно доступно только для чтения для всех пользователей, за исключением суперпользователя. Суперпользователь может самостоятельно назначить принадлежность образца любому акрониму. Автозаполнение осуществляется на основе привязки пользователей к акронимам. 

Поле используется при формировании заглавия этикетки. 

Страна
------

Рекомендуемое к заполнению поле. Необходимо выбрать страну происхождения гербарного сбора. 
Поиск осуществляется по русскоязычным и англоязычным общепринятым в рамках стандарта ISO_ перечнем стран.

.. _ISO: https://ru.wikipedia.org/wiki/ISO_3166-1

Данное поле отображается на английском языке на этикетке. 

Регион
------

Отражается на этикетке. Это поле с возможным автозаполнением из того, что уже было введено в базу.


Район
-----

Не отражается на этикетке. Опциональное поле. 


Место сбора
-----------

Это поле отражается на этикетке на том языке, на котором заполнено. Максимальная длина этого поля 300 символов. 
В этом поле следует также размещать важную информацию об экологических особенностях места сбора.


Координаты
----------

Для заполнения можно использовать флажок на прилагаемой карте google. При изменении его позиции, автоматически изменяются и координаты. 
В правом верхнем углу карты есть и поисковое поле, можно ввести здесь название населенного пункта и флажок переместится в центр этого пункта, если, конечно, такой будет найден (т.е. известен google).

Высота
------

Высота над уровнем моря в метрах.


GPS-Based
---------

Отмечается, если координаты сбора были получены при помощи GPS; это характеристика точности позиционирования сбора; поскольку координаты сбора могут быть получены исходя из описания сбора соответствующим указанием положения флажка на google-карте.

Собрали
-------

Поле-автоподсказка. Автоподсказка формируется из уже известных уникальных записей, внесенных в базу. 


Начало и Конец сбора
--------------------

Для заполнения может быть использован всплывающий календрик (кнопка справа). Начало и конец указываются если не известна точная дата сбора, но известны, например, даты проведения экспедиции, в ходе которой был
осуществлен сбор.

Если дата известна точно, то можно заполнить только одно поле -- начало сбора; также можно указать конец сбора, таким же как и начало сбора, либо оставить пустым. 

Дата сбора отражается на этикетке, в виде, например, таком: 15 Jul 1998. 

Если известен только месяц сбора, то этот факт следует отражать указав начало сбора -- первое число месяца, а конец сбора -- последнее число месяца. Например, если сбор выполнен в марте, 1999 года, то начало сбора будет 1 марта 1999 г, а конец сбора -- 31 марта 1999 г.

Если время сбора указано с точностью до года, следует поступать аналогичным образом -- указать первое и последнее числа года -- 1 января и 31 декабря.


Определили
----------

Поле-автоподсказка. Работает  по аналогии с полем "Собрали". Отражается на этикетке. Если ученых, участвующих в определении много, на этикетке будет указан сокращенный вариант -- первые одна, две фамилии (сколько удастся разместить). 


Начало и конец определения
--------------------------

Аналогично началу и концу сбора. Поле не отражается на этикетке.


Биоморфологический статус
-------------------------

Отражается на этикетке, если непусто. Возможные значения "Dev.stage partly" или "life form". Эти словосочетания и печатаются на этикетке. Специально для биоморфологического гербария БСИ ДВО РАН.
Вполне возможно, оно будет строго привязано к гербарной группе "Биоморфологический гербарий", и не будет
появляться у пользователей, не привязанных к этой группе. 


Подраздел гербария
------------------

Тоже самое что гербарная группа.
Автоматически назначаемое поле и доступное только для чтения для регулярных пользователей и кураторов. 
Может быть пустым. Суперпользователь может редактировать данное поле и указывать гербарную группу образца явно. В других случаях она назначается исходя из привязки пользователя гербарной группе. 
Назначается при сохранении образца. До сохранения -- не определена. 

Заметки
-------

Все что еще мы хотим сообщить о сборе. Для этого здесь доступно 1000 символов. 

Опубликовано
------------

Если отмечено, то образец опубликован. 
Публиковать образцы (как и снимать их с публикации) могут только кураторы герабрия\\гербарной группы, а также суперпользователь.

Определения
-----------

Определения заполняются, если первоначально определенный вид, потом переопределили. На этикетке, однако, при этом сохраняется первоначальные данные. История переопределений не отражается на этикетке. 
В разделе "Определения" можно добавить несколько определений, указав сооветственно начало ( и при необходимости конец) определения. Последним полем строки "Определения" является вид, то на что текущий вид был переопределен.

Если этот раздел заполнен, то он отображается на персональной странице образца.

Если поле "Определили" пусто, а история определений имеется, то на этикетке будет отображена 
последняя информация из истории определений.

**Важно:** Если отметить галочку `Опубликовано`_ до того, как произведено сохранение, то изменения в разделе "Определения" не сохраняться. Чтобы этого избежать, нужно сначала сохранить все измненения (нажав "Сохранить и продолжить редактирование"), а потом уже поставить галочку "Опубликовано" и сохранить снова.  *Это ошибка, и она будет исправлена*.

Дополнительные виды
-------------------

Раздел доступен для редактирования только пользователям с правами "Редактор криптогамного гербария" (пользователей со специальными правами, у которых в сборах может быть больше одного вида).

Дополнительные виды заполняются по аналогии с полем "Определения". Здесь, однако, указываются
также сроки валидности определений; это сделано для того, чтобы можно было отслеживать историю переопределений дополнительных видов.

**Важно:** Если отметить галочку `Опубликовано`_ до того, как произведено сохранение, то изменения в разделе "Дополнительные виды" не сохраняться. Чтобы этого избежать, нужно сначала сохранить все измненения (нажав "Сохранить и продолжить редактирование"), а потом уже поставить галочку "Опубликовано" и сохранить снова.  *Это ошибка, и она будет исправлена*.


-----------------------------
Персональная страница образца
-----------------------------

Детальная информация об опубликованном образце доступна по адресу: http://botsad.ru/hitem/ID,
где "ID" это уникальный код образца, назначаемый системой. 

На этой странице указывается история определений, заметки и прочая информация, не вошедшая на этикетку.

Адрес персональной страницы не зависит от акронима и\\или гербарной группы.

--------
Этикетка
--------

Этикетка генерируется только для уже опубликованных образцов. 

За один запрос можно сгенерировать не более 4-х этикеток; в случае четырех этикеток, они автоматически размещаются на странице формата A4. В случае меньшего их числа, на возвращаемой pdf-странице остается свободное место. 

QR-код, размещаемый на этикетке, шифрует URL персональной страницы образца, также указываемый мелким шрифтом сразу под изображением QR-кода.

Если среди опубликованных образцов для генерации этикетки будут выбраны и неопубликованные -- последние будут проигнорированы, а этикетки будут созданы только для опубликованных записей.


--------------
Известные виды
--------------

Все известные виды хранятся в трех таблицах -- таблице семейств, таблице родов и, собственно, названий видов.
Названия видов с авторами привязаны к таблице родов, элементы таблицы родов -- привязаны к таблице семейств. 

Таблица названий видов используется для формирования подсказок при заполнении поля **Вид** формы гербарного образца. 
Каждая запись таблицы видов имеет дополнительный статус -- "From plantlist", "Approved", "Deleted" и  "Recently added".

Названия видов, имеющие статус "From plantlist" или "Approved" считаются доверенными, и образцы, в которых участвуют такие виды, могут быть беспрепятственно опубликованы куратором гербария. 

В случае, если название вида имеет статус "Recently added" (недавно добавленный), и оно участвует в гербарной записи, такую 
гербарную запись опубликовать не получится.

Чтобы опубликовать такую запись необходимо, чтобы куратор (или суперпользователь) изменил статус вида (проверил вид) на "Approved".

Ни куратор, ни регулярный пользователь не может полностью удалить вид из таблицы известных видов. Вместо этого, куратор может изменить статус вида на "Удаленный" ("Deleted").
Виды, имеющие статус "Deleted", не участвуют во всплывающих списках при заполнении полей формы гербарного образца. В таблице видов отображаются все виды, в том числе и имеющие статус "Deleted".
Таким образом, статус "Deleted" должен использоваться чтобы ограничить результаты поиска во всплывающих подсказках, что может быть полезным чтобы исключить устаревшие и\\или неправильные названия видов.


Регулярный пользователь (наборщик гербария) не может изменить статус вида на "Approved"

-----------
Изображения
-----------

Подготовка изображений для привязки их к гербарным образцам регламентируется отдельным документом_.

.. _документом: https://github.com/VBGI/herbs/blob/master/herbs/fixtures/rules.rst


