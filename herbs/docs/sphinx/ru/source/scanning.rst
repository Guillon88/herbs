================================================================
Правила и структура каталогов для загрузки гербарных изображений
================================================================

.. |---| unicode:: U+2014  .. em dash

.. index:: сканирование образцов

Мотивация
~~~~~~~~~

Поскольку каждое гербарное изображение предполагается представлять в высоком разрешении,
что повлечет за собой увеличение требуемого места на сервере, хранение таких изображений
будет отдельной задачей, минимально связанной с заполнением электронного гербария.

Выделение процесса создания гербарных изображений в независимый процесс позвoлит также организовать
обработку таких изображений (предположительно, общим объемом более 600 GB),
исключив дополнительную нагрузку на основной сервер. 

Таким образом,  это не только обеспечит экономию дискового пространства на основном сервере, но и
предоставит возможность независимо наполнять базу изображениями,
что важно в плане ее скорейшего ввода в полноценный режим работы.

Формирование финальных web-страниц гербарных образцов будет в этом случае осуществляться с подгрузкой 
соответствующих изображений, которые должны быть строго структурированными и привязанными
к конкретным гербарным образцам.

С целью  такой привязки, а также удобства последующей автоматизированной
обработки изображений (создания малых их копий для предпросмотра и т.п.)
ниже приводится система соглашений о размещении и наименовании изображений.

.. index:: сохранение изображений образцов

Структура каталогов
~~~~~~~~~~~~~~~~~~~

Изображения, привязанные к гербарным образцам, должны
иметь имена определенного формата и размещены по каталогам следующим образом:

Общее правило названия файлов и структуры каталогов:

ACRONYM/[ID, CODE]/[ARBITRARY/SET/OF/NESTED/FOLDERS]/ddddd<_dd<p>>.ext


Пояснения:

        * ACRONYM |---| папка, указывающая на принадлежность изображений гербарию данного акронима (у нас это VBGI).

        * [ID, CODE] |---| ID и/или CODE;
          внутри папки акронима гербария находятся папки ID, CODE; Кроме ID и CODE |---| другие названия недопустимы,
          если внутри папки акронима, кроме этих двух (или какой-либо одной из этих двух папок) имеются
          посторонние папки/файлы, структура каталогов считается неправильной.
          В папке ID размещаются изображения, привязанные к гербарным образцам по полю ID электронной базы данных
          (это поле назначается автоматически системой при сохранении гербарных образцов);
          В папке CODE размещаются изображения, привязанные к гербарным образцам по полю CODE
          (это поле назначает куратор гербария, оно уникально внутри данного акронима);

        * [SET/OF/NESTED/FOLDERS] |---| множество вложенных папок с изображениями;
          вложения делаются лишь для удобства человека, создающего гербарные изображения;
          например, если сегодня 16 февраля 2017 года кто-либо создал некий набор изображений
          гербарных образцов, привязанных по ID, он может создать в папке ID вложенную папку,
          например, 16.02.2017, и уже туда поместить соответствующие изображения.
          В следующий день, он также может создать папку 17.02.2017 и т.д.
          Можно также выполнять разделение по семействам/родам. Наличие вложенных папок
          не обязательно, но они позволяют структурировать расположения файлов, что
          прежде всего важно для сканирующего (создающего) изображения гербарных листов человека.
        * ddddd<_dd<p>>.ext |---| представляет собой имя файла изображения (символы "<" и ">"
          обозначают начало и конец опциональных компонент имени файла), где:
          
                * до символа `_`  идет числовой ID либо CODE гербарного образца, к которому привязывается изображение;
         
                * после символа `_`  идет номер изображения данного гербарного образца; это делается
                  для того, чтобы отличить имена файлов гербарных изображений в случае, если одному
                  гербарному образцу соответствует несколько изображений; нумерация изображений строго идет от 1.

                * если опциональная компонента `<_dd<p>>` отсутствует в имени файла, то файл изображения
                  считается единственным изображением гербарного листа данного сбора;
          
                * <p> |---| опциональный символ, указывающий, что данное изображение является
                            изображением места сбора, а не гербарного образца (указывается без символов "<", ">").
          
                * .ext |---| расширение файла (обычно |---| .jpg)
          
                * ПРИМЕРЫ ВАЛИДНЫХ ИМЁН ФАЙЛОВ: 348234_1.jpg, 12345_1.jpg, 12345_1p.jpg, 83727_1.jpg, 83727_2.jpg, 132543.jpg


.. index:: авторство изображений, информация об изображениях

Авторство снимков
~~~~~~~~~~~~~~~~~

Если возникает необходимость указать авторство фотографии, наряду с файлом cнимка
должен быть подготовлен файл метаинформации.

Если имя файла снимка, допустим, 12345_1.jpg, то если необходимо назначить
авторство этой фоторафии, в том же каталоге
должен быть сохранен текстовой файл с расширением .meta,
т.е.  12345_1.meta должен быть, например, следующего содержания:

{"photographer": "Dmitry E. Kislov"}



Файл должен содержать валидный JSON-форматированный текст. Кодировка при сохранении файла должа быть utf-8.

Аналогично со снимками места сбора, если имя файла снимка 123456_1p.jpg,
то имя файла метаинформации будет: 123456_1p.meta.

Пример meta-файла можно загрузить по :download:`ссылке <files/12345_1.meta>`.


Примеры размещения файлов гербарных образцов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    * размещение без вложенной структуры каталогов (в куче): VBGI/ID/132432_1.jpg, VBGI/ID/132432_2.jpg, ...; VBGI/CODE/13212_1.jpg, VBGI/CODE/13211_1.jpg,...

    * размещение с пользовательской структурой каталогов: VBGI/ID/17.02.2017/63723_1.jpg, VBGI/CODE/18.02.2017/65123_1.jpg, VBGI/CODE/18.02.2017/65123_1p.jpg, ...


.. index:: доступ к изображениям гербария


Доступ к файлам
---------------

Вводимая выше структура каталогов предназначена для удобной организации работы
с изображениями и последующей их автоматизированной обработки с целью
загрузки на сервер.

Обработанные файлы изображений будут доступны для чтения по протоколу HTTP по адресам:


 * http://BASE_URL/ss/ACRONYM/[ID, CODE]/ddddd_dd<p>.ext
 * http://BASE_URL/ms/ACRONYM/[ID, CODE]/ddddd_dd<p>.ext
 * http://BASE_URL/fs/ACRONYM/[ID, CODE]/ddddd_dd<p>.ext

где BASE_URL |---| адрес сервера, через который будут доступны
изображения (возможно botsad.ru, возможно, какой-нибудь herbstatic.botsad.ru); далее |---|  ss, ms, fs  |---| указывают
на пути к изображениям различного разрешения: ss (small size) |---| максимальная ширина или высота 100 px,
ms (medium size) |---| максимальная ширина или высота изображения 2000 px; fs (full size) |---|
максимальная ширина или высота ограничивается возможностью сканирующего устройства.

Пользовательская структура каталогов (SET/OF/NESTED/FOLDERS) при размещении на сервере не сохраняется.

Режим доступа к изображениям размера full size |---|  будет
регламентирован позже (при введении базы в эксплуатацию).


.. index:: калибровка изображений

Калибровочные ячейки
--------------------

Крайне рекомендуется на сканах гербарных образцов представлять калибровочные ячейки, и желательно, разных цветов.

Калибровочные ячейки используются для автоматизированного пересчета соответствия между "количеством пикселей" и
принятыми единицами длины.

Калибровочные ячейки должны быть строго одинаковыми для всех изображений, размером |---| 1 cm x 1 cm.

Установленный формат калибровочных ячеек
можно найти по :download:`ссылке <files/color_cells.pdf>`

Выполненные в ярких разных цветах калибровочные квадраты позволят
потенциальным пользователям электронного гербария
идентифицировать где находится калибровочный квадрат, а
где элемент растительности в автоматизированном режиме при помощи
соответствующих программных решений.

Пример гербарного изображения с калибровочными ячейками можно посмотреть ниже.

.. image:: http://insider.si.edu/wordpress/wp-content/uploads/2011/01/us00002212.jpg
   :width: 500 px
   :align: center

