{% load  i18n sekizai_tags %}

<!--  ===================== Info ============================ 
Author: Dmitry E. Kislov
E-mail: kislov@easydan.com
Created: 30 Aug, 2016
	  ======================================================== -->

<!--  ============Herbitem main searchform ================== --> 

<div id="herb-search-form">
  <ul>
	<li><label for="family-input">{%trans "Семейство"%}:</label><div><select id="family-input"></select><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div> </div></li>  
	<li><label for="genus-input">{%trans "Род"%}:</label><div><select id="genus-input"></select><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div></li>
  <li><label for="species-input">{%trans "Вид"%}:</label><div><input type="search" id="species-input"></select><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div></li>
  <li><label for="itemcode-input">{%trans "Код"%}:</label><div><input type="search" id="itemcode-input"></select><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div></li>

  <li><label for="collectedby-input">{%trans "Собрал(и)"%}:</label><div><input type="search" id="collectedby-input" value="" placeholder="{%trans "Текстовое поле"%}"><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div></li>
	<li><label for="identifiedby-input">{%trans "Определил(и)"%}:</label><div><input type="search" id="identifiedby-input" value="" placeholder="{%trans "Текстовое поле"%}"><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div></li>

  <li><label for="country-input">{%trans "Страна"%}:</label><div><select id="country-input"></select><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></li>

  <li><label for="place-input">{%trans "Место сбора"%}:</label><div><input type="search" id="place-input" value="" placeholder="{%trans "Место сбора"%}"><div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></li>
  <li><label for="colend-input">{%trans "Даты сбора"%}:</label><div><input type="search" id="colstart-input" value="" placeholder="{%trans "Начало сбора"%}"> -
  <input type="search" id="colend-input" value="" placeholder="{%trans "Конец сбора"%}"> <div class="clear-button"><span class="ui-icon ui-icon-trash"></span></div></div>
	</li>
	<li><input type="submit" id="searchform-clear" value="{%trans "Очистить"%}"></li>
	<li><input type="submit" id="herbitemform-button" value="Найти"></li> 
  </ul>
</div> 

<!--  ======================================================== -->
<!--  ============Herbitem content found ===================== --> 
<div id="herbitem-content-found"></div>
<!--  ======================================================== -->

<!--  ======================================================== -->

<!-- ============-Searchform template ======================== -->
<script id="searchform-template" type="text/x-underscore-template">

<div id="herbitem-page-lister">
    <span class="step-links">
        <% if (has_previous){ %>
            <span id="herbitem-previous-page"  onclick="incrPage(this,-1)">{% trans "Предыдущая" %}</span>
        <% } %>
        
        <span class="current">
            {% trans "Страница" %} <%= pagenumber %> {%trans "из"%} <%= pagecount %>.
        </span>
        <% if (has_next) {%>
        	<span id="herbitem-next-page"  onclick="incrPage(this,1)">{% trans "Следующая" %} </span>
        <% } %>
    </span>
</div>

<table id="herbitem-table" style="width: 100%;">
   <thead>
    <tr style="height:3em;">
     <td>  {% trans "Код объекта"%} </td>
     <td>  {% trans "Вид"%} </td>
     <td>  {% trans "Дата сбора"%} </td>
     <td>  {% trans "Коллектор(ы)"%} </td>
     <td>  {% trans "Определил(и)"%} </td> 
</tr> 
   </thead>
	<tbody>
		<%
        _.each(items, function(item, index, list){
       var itemcode = (item.itemcode == '') ? '*': item.itemcode;
			 var fieldid  = (item.fieldid == '') ? '': ('/' + String(item.fieldid));
       var herbid = item.id;
       var coldate = item.collected_s;
       var collectors  = item.collectedby;
			 var species = item.species;
       var identifiers = item.identifiedby; 
       var idstr = itemcode + '/' + herbid + fieldid;

		if (index % 2 == 0) { %>
    <tr class="herbitem-even" onclick="window.open('http://botsad.ru/hitem/<%= herbid %>');">
			<td><%= idstr %></td>
			<td><%= species %></td>
			<td><%= coldate %></td>
			<td><%= collectors %></td>
			<td><%= identifiers %></td>
		</tr>
   <%	} else { %>
    <tr class="herbitem-odd" onclick="window.open('http://botsad.ru/hitem/<%= herbid %>');">
			<td><%= idstr %></td>
			<td><%= species %></td>
			<td><%= coldate %></td>
			<td><%= collectors %></td>
			<td><%= identifiers %></td>
		</tr>
	<%	}}); %>
	</tbody>   
</table>
</script>
<!--  ======================================================== -->

{%addtoblock "css"%}
<link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" rel="stylesheet" >
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">

<style type="text/css">
#family-input, #genus-input, #species-input, #country-input, #itemcode-input 
	{
	width:300px;
  }
.clear-button{
	display: none;
	cursor:pointer;
	}
#herb-search-form>ul{
list-style-type: none;
}	
#herb-search-form>ul li{
padding-bottom:10px;
}
label {font-weight: bold; display:block;}
label + * {margin-left: 2em; margin-top: 5px;}

.herbitem-even{
  background: #EEEEEE;
  height: 2em;

}
#herbitem-page-lister{
  text-align: center;
  margin-bottom: 5px;  
}

.herbitem-odd{
  background: #FFFFFF;
  height: 2em;
}
.herbitem-even:hover, .herbitem-odd:hover{
background: #EEFFAA;
cursor: pointer;
}

#herbitem-table {
width:100%;
}

#herbitem-table > thead{
background: #22FFAA;
}

#herbitem-content-found {
  display: block;
  float: left;
}

#herb-search-form{
  display:block;
  float:left;
}


#herbitem-next-page, #herbitem-previous-page {
  cursor: pointer;
  border-radius: 5px;
  padding: 5px;
}

#herbitem-next-page:hover, #herbitem-previous-page:hover {
  background: #EEFFAA;
}

</style>


{%endaddtoblock%}

{%addtoblock "js"%}
<!-- 	================== Main javascript code ===============- -->

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>

<!-- TODO: Insert if lang_code is eng only -->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/i18n/ru.js"></script>
<script src="//code.jquery.com/ui/1.12.0/jquery-ui.js"></script>



<script type="text/javascript" >
var cpage = 1; // Current paginated page 

function incrPage(el, inc){  // Just increment the page number 
cpage = cpage + inc
herbitemFind();
}

function getornone(el){
var res = null;
var obj = $(el).select2('data');
if (obj !== undefined){
	if (obj[0] !== undefined){
		res = obj[0].text;	
	}
}
return res;
}



function createSearchResult(idata){
// idata -- assumed to be a plain object (converted from json response)
var sftempl = _.template($("#searchform-template").html());
var output = sftempl({items:idata.herbobjs, has_previous: idata.has_previous,
							total: idata.total, 
							has_next: idata.has_next,
							pagenumber: idata.pagenumber,
							pagecount: idata.pagecount							
							}); 
return output
}

function bindSearch(model, mname){
	var element = '#' + model + '-input';
	
$(element).select2({
		language: "{{request.LANGUAGE_CODE}}",
		placeholder: '{%trans "Выберите " %}' + mname,
		ajax: {
    	 url: "{% url 'herbs.views.advice_select' %}",
  		 dataType: 'json',
  		 type: 'GET',
    	 delay: 250,
    	 cache: false,
    	 data: function (params) { 
				    	var familyname = $("#family-input :selected").text();
							var genusname = $("#genus-input :selected").text();
    	 					return {q: params.term,
    	 					model: model,
    	 					family: familyname,
    	 					genus: genusname,
    	 					};
    	 					},
	 processResults: function (data, page) {
      	return {
        	results: data.items
      	};},
    	 },
    	 escapeMarkup: function (m) { return m; }
    		});
}

function herbitemFind(){
	var family = getornone('#family-input');
	var genus = getornone('#genus-input');
	var species = $('#species-input').val();
	var itemcode = $("#itemcode-input").val();
	var identifiedby = $("#identifiedby-input").val();
	var collectedby = $("#collectedby-input").val();
	var country = getornone("#country-input");
	var colstart = $("#colstart-input").val();
  var colend = $("#colend-input").val();
  var place = $("#place-input").val();
  // TODO: orderby field, increasing decreasing ordering
  // 
  var orderby = null;
  var order = null;
  // TODO: latl lonu etc... positioning needed
  var latl = null;
  var latu = null;
  var lonl = null;
  var lonu = null
  var outputHTML = '';
  var commonError = "{%trans "Возникла ошибка при получении ответа за поисковый запрос" %}";
	$("herbitem-content-found").html('<div class="centered-ajax-loader"></div>');
	$.get("{% url 'herbs.views.show_herbs' %}",
			{family:family, genus:genus, species:species, itemcode:itemcode,
			identifiedby:identifiedby,place:place,collectedby:collectedby, country:country, colstart:colstart,
			colend:colend, page:cpage,
      latl:latl, lonl: lonl, latu:latu, lonu:lonu,
      orderby:orderby, order:order      
      }).done(function(data) {
			if (data.error.length > 0) {
				outputHTML = data.error
			}
			else {
				outputHTML = createSearchResult(data)}
			}
			).fail(function() {
        $("#herbitem-content-found").html("<h2>" + commonError + "</h2>")
      }).always(function () {
				$("#herbitem-content-found").html(outputHTML); 														 	
 								})	
}

<!-- ============ When DOM is ready ============  -->
$(document).ready(function() { 

 
bindSearch('family', "{% trans 'Семейство'%}");
bindSearch('genus', "{% trans 'Род'%}");
bindSearch('country', "{% trans 'Страну'%}");

$('#herbitemform-button').click(function (event){
	event.preventDefault();
	herbitemFind();
	})
$("#colstart-input, #colend-input").click(function (event){
	$(this).siblings('div.clear-button').css('display', 'inline-block');
})
$("div>input[type=search]" ).keypress(function() {
  $(this).siblings('div.clear-button').css('display', 'inline-block')
});

$('select').on("select2:selecting", function(e) { 
  $(this).siblings('div.clear-button').css('display', 'inline-block')
});

$('div.clear-button').click(function (event){
$(this).css('display', 'none')
var el = $(this).siblings('select') 
if (el.length !== 0 ) { //Clearing select element
el.select2('val', '');
} else{
$(this).siblings('input[type=search]').val(''); //cleaning regular input field
}
})
$("#colstart-input").datepicker();
$("#colend-input").datepicker();
$("#searchform-clear").click(function (event){
	event.preventDefault();
$('#family-input').select2('val',''); 
$('#genus-input').select2('val', '');
$('#country-input').select2('val', '');
$('div>input[type=search]').val('');
$('div.clear-button').hide();
$( "div#herb-search-form ul li input:text" ).each(function() {  
	$(this).val('');
});

cpage = 1;// <!-- Find cpage in the outer scope and change it; i.e. pagination counter -->
});
herbitemFind();
});
<!--  =========================================== -->
</script>
{%endaddtoblock%}

<!--  ======================================================== -->
